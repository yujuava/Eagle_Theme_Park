<html lang="en">

<head>
    @@include('layout/meta.html', {
    "title" : "伊果商城"
    })
</head>

<body class="shop">
    <!-- 共用header -->
    @@include('layout/header-final.html')
    <!-- 共用header end -->
    @@include('layout/h2Style.html',{
    "h2Title" : "伊果商城"
    })
    <section id="make-post">
        <!-- 大標使用這個-->
        @@include('layout/title.html',{
        "h3TitleTC" : "客製商品",
        "h3TitleEN": "Product"
        })
        <!-- 明信片圖片 -->
        <div class="wrap postbg">
            <div class="slideshow-container">
                <div class="mySliderContainer">
                    <div class="mySlides">
                        <img src="./images/postcard1.jpg">
                    </div>
                    <div class="mySlides fade">
                        <img src="./images/postcard2.jpg">
                    </div>
                    <div class="mySlides fade">
                        <img src="./images/postcard3.jpg">
                    </div>
                    <div class="mySlides fade">
                        <img src="./images/postcard4.jpg">
                    </div>
                    <div class="sliderButton">
                        <div class="prev" onclick="plusSlides(-1)"><i class="fa-solid fa-angle-left"></i></div>
                        <div class="next" onclick="plusSlides(1)"><i class="fa-solid fa-angle-right"></i></div>
                    </div>
                </div>
                <!-- 明信片內容 -->
                <div class="postcard">
                    <img src="./images/postcardback.jpg" alt="">
                    <div class="stamp">
                        <img id="stamp" src="./images/sticker1.png" alt="">
                    </div>
                </div>
            </div>
            <!-- 明信片貼紙 -->
            <div class="postcardWrap">
                <div class="stickerslider">
                    <ul class="sticker">
                        <li><img src="./images/sticker1.png" alt=""></li>
                        <li><img src="./images/sticker2.png" alt=""></li>
                        <li><img src="./images/sticker3.png" alt=""></li>
                        <li><img src="./images/sticker4.png" alt=""></li>
                        <li><img src="./images/sticker5.png" alt=""></li>
                        <li><img src="./images/sticker6.png" alt=""></li>
                        <li><img src="./images/sticker7.png" alt=""></li>
                        <li><img src="./images/sticker8.png" alt=""></li>
                        <li><img src="./images/sticker9.png" alt=""></li>
                        <li><img src="./images/sticker10.png" alt=""></li>
                    </ul>
                </div>
                <button id="sliderLeft">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <button id="sliderRight">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
            <!-- 寄送按鈕 -->
            <div class="upload">
                <button class="bgBtn-shop  shopbtn" id="shopBtn">寄送</button>
            </div>
        </div>
    </section>
    <!-- ---------------------- -->
    <!-- 小標使用這個 -->
    <section id="product-list" v-cloak>
        @@include('layout/title.html',{
        "h3TitleTC" : "商品列表",
        "h3TitleEN": "Product"
        })
        <!-- My name is <input v-model="name"> -->
        <!-- <div class="product wrap">
            <div>
                <div class="itemColumn" v-for="prodRow in prodRows">
                    <div class="item">
                        <div id="lightBtn" class="itempic">
                            <img :src="'images//' + prodRow.product_pic">
                        </div>
                        <div class="card">
                            <p>{{prodRow.product_name}}</p>
                            <p>${{prodRow.product_price}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->
        <div class="product wrap">
            <div>
                <product-component v-for="(item,index) in prodRows" :item="item" :key='item.id' @open-lightbox="isOpen=true"
                    @click.native="setFocusId(item.product_no)"/>
            </div>
        </div>
        <div class="full-screen light" v-show="isOpen">
            <div id="lightBox" class="lightbox-bdr light-box">
                <div class="lightBoxContent">
                    <productdetail-component @tocart="addcartlocal" @count="countadd" :item="showthispro">
                    </productdetail-component>
                    <i @click="isOpen = false" class="fa-solid fa-xmark" id="turnOff"></i>
                </div>
                <span id="boxBcg"></span>
            </div>
        </div>
    </section>
    <!--  ===============map ===============  -->
    @@include('layout/map.html')
    <!-- footer  -->
    @@include('layout/footer.html')
    <!-- 燈箱 -->



    <!-- ----------------------------------------------------------- -->
    <script>
        let carts = [];

        const items = [
        //     {
        //     id: 1,
        //     image: "./images/shop_cup.png",
        //     name: "伊果馬克杯",
        //     price: 300,
        //     amount: 1,
        // }, {
        //     id: 2,
        //     image: "./images/shop_keyring.png",
        //     name: "伊果鑰匙圈",
        //     price: 150,
        //     amount: 1,
        // }, {
        //     id: 3,
        //     image: "./images/shop_bottle.png",
        //     name: "伊果保溫瓶",
        //     price: 600,
        //     amount: 1,
        // }
    ]
        Vue.component('product-component', {

            methods: {
                show() {
                    this.$emit("open-lightbox");
                }
            },
            template: `
            <div @click="show" class="itemColumn">
                <div class="item">
                    <div class="itempic" id="lightBtn">
                        <img :src="'images//' + item.product_pic">
                    </div>
                    <div class="card">
                        <p>{{item.product_name}}</p>
                        <p>{{'$'+item.product_price}}</p>
                    </div>
                </div>
            </div> `,
            props: {
                item: Object,
                isOpen: false,
            }
        });
        Vue.component('productdetail-component', {

            methods: {
                countadd(id, amount) {
                    this.$emit('count', id, amount)
                },
                addtocart(id, amount) {
                    this.$emit('tocart', id, amount)
                }
            },
            template: `
            <div class="column">
                <div class="columnpic">
                    <img :src="'images//' + item.product_pic">
                </div>
                <div class="column inforcolumn">
                    <div class="productName">
                        <p>{{'商品名稱: '+item.product_name}}</p>
                    </div>
                    <div class="productName">
                        <p>{{'商品描述: '+item.product_infor}}</p>
                    </div>
                    <div class="productPrice">
                        <p>{{'價格: $ '+item.product_price}}</p>
                    </div>
                    <form>
                        <div class="count">
                            <div @click="countadd(item.product_no,-1)"class="addamount">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <input type="text" class="num" min="0" v-model="item.product_amount" disabled>
                            <div class="addamount" @click="countadd(item.product_no,1)">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                        </div>
                        <input type="button" @click="addtocart(item.product_no)" value="加入購物車" class="mdBtn-addCart">
                    </form>
                </div>
            </div>    
            `,
            props: {
                item: Object,
                isOpen: false,
            }
        });
        var prods = new Vue({
            el: "#product-list",
            data:{
              
              isOpen: false,
              items,
              focusKey: '',
              carts,
              prodRows:[],
              
            },
            computed: {
                showthispro() {
                    //打開箱對應商品燈箱內容
                    return this.prodRows.find(v => v.product_no == this.focusKey) ?? this.prodRows[0];
                },
            },
            watch: {
                shoppingcarts(carts) {
                    localStorage.shoppingcarts = JSON.stringify(carts);
                }
            },
            methods: {
                //計算燈箱內商品數量加減
                countadd(id, amount) {
                    console.log(id)
                    let item = this.prodRows[id - 1].product_amount + amount;
                    if (item >= 1) {
                        this.prodRows[id - 1].product_amount = item;
                    }
                },
                show() {
                    this.isOpen = true;
                },
                setFocusId(product_no) {
                    this.focusKey = product_no;
                    this.$nextTick(() => {})
                },
                //加入購物車被點擊時打商品資料加入localstorage
                addcartlocal(id, amount) {
                    //關燈箱
                    this.isOpen = false;
                    //拿到最新的CARTS
                    if (localStorage.getItem('carts') === null) {
                        localStorage.setItem('carts', JSON.stringify(carts));
                    //當localStorage已存在資料陣列，指定一個內容與陣列資料庫相同的陣列
                    } else {
                        carts = JSON.parse(localStorage.getItem('carts'));
                    };
                    //如果有相同ID -> 更新相對應ID的數量
                    const idList = carts.map(item => Object.values(item)[0]);
                    //有存在(更新數量放回localstorage)
                    if (idList.indexOf(id) != -1) {
                        carts[idList.indexOf(id)].product_amount += this.prodRows[id - 1].product_amount
                        alert('已加入購物車')
                    //不存在(整筆商品放入localstorage)
                    } else {
                        console.log(id)
                        let sumid = this.prodRows[id - 1];
                        carts.push(sumid)
                        alert('已加入購物車')
                    }
                    localStorage.setItem('carts', JSON.stringify(carts));
                    //同步更新小購物車數量
                    headerVue.getCarts();
                }
            },
        })
        const prodRows = [];

        function getProducts() {
        let xhr = new XMLHttpRequest();
        xhr.onload = function () {
            prods.prodRows = JSON.parse(xhr.responseText);
            // console.log(prods.prodRows);
        }
        xhr.open("get", "./php/get_back_product.php", true);
        xhr.send(null);
        }
        window.addEventListener("load", function () {
            getProducts();
        })
        // console.log(prodRows)
        // console.log(items)
    </script>
    <script src="./js/shopSlideshow.js"></script>
    <script src="./js/shopStickerslider.js"></script>
    <script src="./js/postcardStamp.js"></script>
</body>

</html>